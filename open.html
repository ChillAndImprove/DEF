<!DOCTYPE html>
<html>
<head>
    <title>Load Threat Model</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script>
        // CRITICAL SCRIPT: Must be the first script in the head.
        // Sets the theme based on user preference to prevent FOUC.
        (function() {
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                } else {
                    document.documentElement.classList.remove('dark-mode');
                }
            }
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme) {
                applyTheme(savedTheme === 'true' ? 'dark' : 'light');
            } else {
                // Default to dark mode unless explicitly set to light
                applyTheme('dark');
            }
        })();
    </script>
    <style>
        /* CRITICAL CSS: Prevents white flash on page load for dark mode */
        html.dark-mode, html.dark-mode body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
        }
    </style>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 15px;
            font-size: 10pt;
            background-color: #f8f9fa;
            margin: 0;
        }
        h2 { margin-top: 0; margin-bottom: 15px; color: #343a40; font-size: 1.4em;
             border-bottom: 1px solid #dee2e6; padding-bottom: 5px; }
        h3 { margin-top: 15px; margin-bottom: 10px; color: #495057; font-size: 1.1em; }
        section { margin-bottom: 20px; padding: 15px; background-color: #ffffff;
                  border: 1px solid #dee2e6; border-radius: 4px; }

        .geBtn {
            display: inline-block; font-weight: 400; color: #212529; text-align: center;
            vertical-align: middle; cursor: pointer; user-select: none; background-color: #e9ecef;
            border: 1px solid #ced4da; padding: 0.375rem 0.75rem; font-size: 1rem;
            line-height: 1.5; border-radius: 0.25rem; margin-right: 5px; margin-bottom: 5px;
        }
        .geBtn:hover { background-color: #ced4da; border-color: #adb5bd; }
        .gePrimaryBtn { color: #fff; background-color: #007bff; border-color: #007bff; }
        .gePrimaryBtn:hover { background-color: #0056b3; border-color: #004085; }
        .gePrimaryBtn:disabled { background-color: #6c757d; border-color: #6c757d; cursor: not-allowed; opacity: 0.65; }

        /* Gray out incomplete example templates */
        .geBtn.disabled {
            background-color: #e9ecef;
            color: #6c757d;
            border-color: #ced4da;
            cursor: not-allowed;
            opacity: 0.65;
            pointer-events: none;
        }

        .standard-flag {
            font-size: 32px; margin-right: 10px; cursor: pointer;
            border: 2px solid transparent; border-radius: 3px; vertical-align: middle;
            transition: border-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-block; padding: 5px;
        }
        .standard-flag:hover { border-color: #adb5bd; transform: scale(1.1); }
        .standard-flag.selected {
            border-color: #007bff; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        /* ðŸ”’ Disable and gray out everything except German (BSI) */
        .standard-flag:not([data-standard="BSI"]) {
            pointer-events: none;
            opacity: 0.3;
            cursor: not-allowed;
        }
        /* No hover effects for disabled flags */
        .standard-flag:not([data-standard="BSI"]):hover {
            border-color: transparent;
            transform: none;
        }

        #upload-section input[type="file"] { display: block; margin-bottom: 10px; font-size: 0.9em; }
        #openSupported { font-size: 0.85em; color: #6c757d; margin-top: 5px; }
        .button-bar { margin-top: 20px; text-align: right; padding-top: 15px; border-top: 1px solid #dee2e6; }

        #upload-section.drag-over {
            background-color: #e7f3ff;
            border: 2px dashed #007bff;
        }

        /* Dark Mode Styles - Prevent flash */
        html.dark-mode {
            background-color: #1a1a1a !important;
        }

        html.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        html.dark-mode h2 {
            color: #e0e0e0;
            border-bottom-color: #444;
        }
        html.dark-mode h3 {
            color: #d0d0d0;
        }
        html.dark-mode section {
            background-color: #2a2a2a;
            border-color: #444;
        }
        html.dark-mode .geBtn {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }
        html.dark-mode .geBtn:hover {
            background-color: #4a4a4a;
            border-color: #666;
        }
        html.dark-mode .gePrimaryBtn {
            background-color: #0056b3;
            border-color: #004085;
        }
        html.dark-mode .gePrimaryBtn:hover {
            background-color: #004085;
        }
        html.dark-mode .geBtn.disabled {
            background-color: #2a2a2a;
            color: #666;
        }
        html.dark-mode #openSupported {
            color: #999;
        }
        html.dark-mode .button-bar {
            border-top-color: #444;
        }
        html.dark-mode #upload-section.drag-over {
            background-color: #1a3a5a;
            border-color: #4a90d9;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background 0.3s;
            z-index: 1000;
        }
        .dark-mode-toggle:hover {
            background: #0056b3;
        }
        html.dark-mode .dark-mode-toggle {
            background: #ffa500;
        }
        html.dark-mode .dark-mode-toggle:hover {
            background: #ff8c00;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" id="darkModeToggle">ðŸŒ™ Dark Mode</button>

    <h2>Load or Start New Threat Model</h2>

    <section id="examples-section">
        <h3>Start with an Example:</h3>
        <button type="button" id="customer_portal_erp_threat_model" class="geBtn exampleBtn" data-path="backend/customer_portal_erp_threat_model.triangle">Portal + ERP</button>
        <button type="button" id="basic_webapp" class="geBtn exampleBtn disabled" data-path="backend/basic_webapp_threat_model.yaml" title="Coming soon - not yet implemented">Basic Web App (Coming Soon)</button>
        <button type="button" id="simple_api_threat_model" class="geBtn exampleBtn disabled" data-path="backend/simple_api_threat_model.yaml" title="Coming soon - not yet implemented">Simple API (Coming Soon)</button>
        <button type="button" id="kubernetes_api_threat_model" class="geBtn exampleBtn disabled" data-path="backend/kubernetes.yaml" title="Coming soon - not yet implemented">WebGIS with Kubernetes (Coming Soon)</button>
    </section>

    <section id="standard-section">
        <h3>Select Threat Standard / Region:</h3>
        <span class="standard-flag" data-standard="BSI" title="German BSI Standards">ðŸ‡©ðŸ‡ª</span>
        <span class="standard-flag" data-standard="NIST" title="US NIST/NSI Standards">ðŸ‡ºðŸ‡¸</span>
        <span class="standard-flag" data-standard="ANSSI" title="French ANSSI Standards (Future)">ðŸ‡«ðŸ‡·</span>
        <span class="standard-flag" data-standard="GENERIC" title="Generic / EU ENISA Baseline">ðŸ‡ªðŸ‡º</span>
    </section>

    <section id="upload-section">
        <h3>Upload Your Own Model:</h3>
        <form method="POST" enctype="multipart/form-data" action="" name="openForm" id="openForm" onsubmit="return handleSubmit();" accept-charset="UTF-8">
            <input type="file" name="upfile" id="fileInput" onchange="fileChanged()" accept=".triangle">
            <div id="openSupported">Supported format: .triangle (Triangle binary format)<br>
            <strong>ðŸ’¡ Tip:</strong> Drag and drop a .triangle file anywhere on this window!</div>
        </form>
    </section>

    <section id="bsi-catalog-section" style="display:none;">
        <h3>BSI IT-Grundschutz Risk Catalog:</h3>
        <button type="button" id="bsi-catalog-btn" class="geBtn" style="background:#2e7d32;color:white;font-weight:bold;padding:12px 20px;">
            ðŸ“– View All 691 BSI Risks
        </button>
        <p style="font-size:0.85em;color:#6c757d;margin-top:8px;">Browse the complete catalog of BSI IT-Grundschutz risks organized by category</p>
    </section>

    <div class="button-bar">
        <input type="button" id="cancelButton" class="geBtn" value="Cancel" onclick="hideWindow(true);">
        <input type="submit" form="openForm" id="openButton" class="geBtn gePrimaryBtn" value="Open" disabled="disabled">
    </div>

<script type="text/javascript">
    function handleFiles(files, isExample = false) {
        if (!files || files.length === 0) return;
        for (var i = 0; i < files.length; i++) {
            (function(file) {
                if (window.parent.openNew) { window.parent.open(window.parent.location.href); }

                // Check if it's a .triangle file
                const isTriangleFile = file.name.toLowerCase().endsWith('.triangle');

                if (isTriangleFile) {
                    // Use obfuscated triangle file handler from parent window
                    if (window.parent.handleTriangleFile) {
                        window.parent.handleTriangleFile(file);
                    } else {
                        alert('Error: Triangle file handler not available. Please reload the application.');
                    }
                } else if (isExample) {
                    // Handle YAML files only for examples
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        if (window.parent.openFile && typeof window.parent.openFile.setData === 'function') {
                            window.parent.openFile.setData(e.target.result, file.name);
                        } else { console.error("Parent 'openFile.setData' not found."); alert("Error: Cannot process file."); }
                    };
                    reader.onerror = function(e) { console.error("File reading error:", e); alert(`Error reading file: ${file.name}`); };
                    reader.readAsText(file);
                } else {
                    // Reject user uploaded files that aren't .triangle
                    alert(`Error: Only .triangle files are supported for upload. Selected file: ${file.name}`);
                }
            })(files[i]);
        }
    }
    function handleSubmit() {
        var fileInput = document.getElementById('fileInput');
        if (window.File && window.FileReader && fileInput.files.length > 0) {
            handleFiles(fileInput.files); return false;
        } else if (fileInput.files.length > 0) {
            if (window.parent.mxUtils) window.parent.mxUtils.alert(window.parent.mxResources.get('invalidOrMissingFile'));
            return false;
        } else {
            if (window.parent.mxUtils) window.parent.mxUtils.alert(window.parent.mxResources.get('invalidOrMissingFile'));
            return false;
        }
    }

    function loadExample(filePath) {
        const isTriangleFile = filePath.toLowerCase().endsWith('.triangle');

        if (isTriangleFile) {
            // Handle .triangle files as binary
            fetch(filePath)
                .then(response => { if (!response.ok) throw new Error(`HTTP ${response.status}`); return response.arrayBuffer(); })
                .then(data => {
                    const filename = filePath.split('/').pop() || 'example.triangle';
                    const blob = new Blob([data], { type: 'application/x-triangle-binary' });
                    const file = new File([blob], filename, { type: 'application/x-triangle-binary' });
                    handleFiles([file], true);
                })
                .catch(error => { console.error(`Error loading ${filePath}:`, error); alert(`Could not load example: ${filePath}`); });
        } else {
            // Handle other files as text (fallback for disabled examples)
            fetch(filePath)
                .then(response => { if (!response.ok) throw new Error(`HTTP ${response.status}`); return response.text(); })
                .then(data => {
                    const filename = filePath.split('/').pop() || 'example.yaml';
                    const blob = new Blob([data], { type: 'text/yaml' });
                    const file = new File([blob], filename, { type: 'text/yaml' });
                    handleFiles([file], true);
                })
                .catch(error => { console.error(`Error loading ${filePath}:`, error); alert(`Could not load example: ${filePath}`); });
        }
    }

    function selectThreatStandard(standardCode, flagElement) {
        console.log(`Threat standard selected: ${standardCode}`);
        document.querySelectorAll('.standard-flag').forEach(flag => flag.classList.remove('selected'));
        if (flagElement) flagElement.classList.add('selected');

        // Show/hide BSI Risk Catalog section based on selected standard
        const bsiCatalogSection = document.getElementById('bsi-catalog-section');
        if (bsiCatalogSection) {
            bsiCatalogSection.style.display = (standardCode === 'BSI') ? 'block' : 'none';
        }

        if (window.parent && typeof window.parent.setThreatStandardContext === 'function') {
            window.parent.setThreatStandardContext(standardCode);
            console.log(`Called parent.setThreatStandardContext with: ${standardCode}`);
        } else {
            console.warn("Parent window does not have a 'setThreatStandardContext' function.");
        }
        try { localStorage.setItem('selectedThreatStandard', standardCode); } catch (e) {}
    }

    function hideWindow(cancel) {
        if (window.parent.openFile && typeof window.parent.openFile.cancel === 'function') {
            window.parent.openFile.cancel(cancel);
        } else { console.error("Parent 'openFile.cancel' not found."); window.close(); }
    }
    function fileChanged() {
        var openButton = document.getElementById('openButton');
        var fileInput = document.getElementById('fileInput');
        openButton.disabled = !(fileInput.value.length > 0);
    }

    function initializeDialog() {
        var openButton = document.getElementById('openButton');
        var cancelButton = document.getElementById('cancelButton');
        if (window.parent.mxResources) {
            openButton.value = window.parent.mxResources.get(window.parent.openKey || 'open', null, 'Open');
            cancelButton.value = window.parent.mxResources.get('cancel', null, 'Cancel');
        }

        document.querySelectorAll('.exampleBtn').forEach(button => {
            button.addEventListener('click', function() {
                // Don't load if button is disabled
                if (this.classList.contains('disabled')) {
                    console.log('Disabled example button clicked, ignoring');
                    return;
                }
                loadExample(this.getAttribute('data-path'));
            });
        });

        // âœ… Only attach click handler to the German flag
        document.querySelectorAll('.standard-flag[data-standard="BSI"]').forEach(flag => {
            flag.addEventListener('click', function() {
                selectThreatStandard('BSI', this);
            });
        });

        // Restore previous selection visually (but keep others disabled)
        try {
            const savedStandard = localStorage.getItem('selectedThreatStandard') || 'BSI';
            const flagToSelect = document.querySelector(`.standard-flag[data-standard="${savedStandard}"]`)
                                  || document.querySelector('.standard-flag[data-standard="BSI"]');
            if (flagToSelect) {
                document.querySelectorAll('.standard-flag').forEach(flag => flag.classList.remove('selected'));
                flagToSelect.classList.add('selected');
                console.log(`Initial standard set/restored to: ${flagToSelect.getAttribute('data-standard')}`);

                // Show BSI catalog section if BSI is selected
                const selectedStandard = flagToSelect.getAttribute('data-standard');
                const bsiCatalogSection = document.getElementById('bsi-catalog-section');
                if (bsiCatalogSection && selectedStandard === 'BSI') {
                    bsiCatalogSection.style.display = 'block';
                }
            }
        } catch(e) {
            const defaultFlag = document.querySelector('.standard-flag[data-standard="BSI"]');
            if (defaultFlag) defaultFlag.classList.add('selected');
        }

        fileChanged();

        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModePref2 = localStorage.getItem('darkMode');
        // Default to dark mode unless explicitly set to false
        const savedDarkMode = darkModePref2 !== 'false';
        if (savedDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = 'â˜€ï¸ Light Mode';
        }

        darkModeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'true' : 'false');
            darkModeToggle.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
        });
    }

    // Drag and drop support
    function setupDragAndDrop() {
        const body = document.body;
        const uploadSection = document.getElementById('upload-section');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            body.addEventListener(eventName, () => {
                uploadSection.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            body.addEventListener(eventName, () => {
                uploadSection.classList.remove('drag-over');
            }, false);
        });

        body.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                const file = files[0];
                if (file.name.toLowerCase().endsWith('.triangle')) {
                    handleFiles([file], false);
                } else {
                    alert('Please drop a .triangle file');
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeDialog();
        setupDragAndDrop();

        // BSI Risk Catalog button handler
        const bsiCatalogBtn = document.getElementById('bsi-catalog-btn');
        if (bsiCatalogBtn) {
            bsiCatalogBtn.addEventListener('click', function() {
                // Open BSI catalog in a new window
                window.open('bsi-risk-catalog.html', 'BSI Risk Catalog', 'width=1400,height=900,resizable=yes,scrollbars=yes');
            });
        }
    });
</script>
</body>
</html>

